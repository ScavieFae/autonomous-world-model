# SBF Toolchain Cargo Cannot Resolve Crates Using `edition = "2024"`

## Goal

Build an Anchor 0.32.1 program targeting SBF using the officially recommended toolchain installed via the one-liner at solana.com/docs/intro/installation.

## What we attempted

Fresh install of the recommended stack:
- Rust 1.93.1 (stable, aarch64-apple-darwin)
- Solana CLI 3.0.15 (Agave)
- Anchor CLI 0.32.1

Program Cargo.toml:
```toml
[dependencies]
anchor-lang = "0.32.1"
```

Ran `anchor build` from the workspace root.

## Expected behavior

`anchor build` compiles the program to an SBF .so file. The dependency tree for `anchor-lang = "0.32.1"` resolves cleanly — confirmed via system cargo 1.93.1:
- `cargo tree -i blake3` → "did not match any packages"
- Generated Cargo.lock contains no blake3 entry

## Actual behavior

`anchor build` fails during crate download:

```
error: failed to download `blake3 v1.8.3`

Caused by:
  unable to get packages from source

Caused by:
  failed to parse manifest at
    .cargo/registry/src/index.crates.io-.../blake3-1.8.3/Cargo.toml

Caused by:
  feature `edition2024` is required

  The package requires the Cargo feature called `edition2024`, but that
  feature is not stabilized in this version of Cargo (1.84.0 (12fe57a9d 2025-04-07)).
```

The SBF toolchain's bundled cargo (v1.84.0) cannot parse `blake3 v1.8.3`'s Cargo.toml because it uses `edition = "2024"`, which cargo 1.84.0 doesn't support.

## The paradox

- **System cargo 1.93.1** resolves the full dependency tree without blake3. It is not a direct or transitive dependency of `anchor-lang = "0.32.1"`.
- **SBF toolchain cargo 1.84.0** attempts to download and parse blake3 1.8.3 anyway — apparently resolving a different dependency graph or ignoring the existing Cargo.lock.
- The Cargo.lock on disk (generated by system cargo) does not contain blake3. Yet `anchor build` / `cargo build-sbf` tries to fetch it.

## Potential causes

1. **SBF cargo resolves independently.** The bundled cargo 1.84.0 may regenerate or ignore the Cargo.lock, resolving a different dependency tree that includes blake3 (perhaps through a platform-specific dependency or the SBF runtime itself).

2. **Stale crates.io index interaction.** Cargo 1.84.0 may resolve `blake3` as a candidate during index traversal even if it's not in the final dependency tree, and fails at manifest parse before it can determine the crate is unnecessary.

3. **`anchor build` runs multiple cargo invocations.** It builds once natively (for IDL generation) and once for SBF. The native build succeeds; the SBF build fails. These may use different resolution strategies.

4. **Platform-tools version lag.** Solana CLI 3.0.15 bundles platform-tools with cargo 1.84.0, but the wider Rust ecosystem has moved to edition 2024 support (stable since Rust 1.85+). Any crate publishing with `edition = "2024"` becomes unparseable by the SBF cargo.

## Key finding: `cargo build-sbf` works, `anchor build` does not

Running `cargo build-sbf` directly compiles the program successfully — no blake3 in the dependency tree, no errors. The SBF toolchain itself is fine.

`anchor build` fails because it runs additional cargo invocations (likely IDL generation on the host target) that resolve a different dependency graph pulling in blake3 1.8.3.

**Workaround:** Use `cargo build-sbf` directly instead of `anchor build`. Generate the IDL separately if needed.

## Suggested fixes

- **Anchor CLI 0.32.1 bug:** The IDL generation pass resolves dependencies that don't appear in the actual SBF build, including blake3 1.8.3 which requires edition 2024. This should be reported to the Anchor team.
- **Update platform-tools** to bundle a cargo >= 1.85.0 that supports edition 2024. This would make `anchor build` work even with the extra resolution, since the cargo would understand edition 2024.
- **Short-term workaround:** Use `cargo build-sbf` directly to compile programs.

## Environment details

```
$ solana --version
solana-cli 3.0.15 (src:42c10bf3; feat:3604001754, client:Agave)

$ anchor --version
anchor-cli 0.32.1

$ rustc --version
rustc 1.93.1 (01f6ddf75 2026-02-11)

# SBF toolchain cargo (from error output):
Cargo 1.84.0 (12fe57a9d 2025-04-07)
```

OS: macOS (Darwin, aarch64)
Installed via: `curl --proto '=https' --tlsv1.2 -sSfL https://solana-install.solana.workers.dev | bash`
